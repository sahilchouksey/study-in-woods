<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Design - Study in Woods</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        @page { size: A4; margin: 1in; }
        body { font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 1.6; color: #000; }
        h1 { text-align: center; font-size: 16pt; font-weight: bold; text-decoration: underline; margin: 20px 0 30px 0; text-transform: uppercase; }
        h2 { font-size: 14pt; font-weight: bold; margin-top: 25px; margin-bottom: 15px; text-decoration: underline; }
        h3 { font-size: 12pt; font-weight: bold; margin-top: 20px; margin-bottom: 10px; font-style: italic; }
        p { text-align: justify; margin-bottom: 12px; text-indent: 0.5in; }
        p.no-indent { text-indent: 0; }
        ul, ol { margin-left: 0.75in; margin-bottom: 12px; }
        li { margin-bottom: 8px; text-align: justify; }
        .page-break { page-break-after: always; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #000; padding: 8px; text-align: left; vertical-align: top; }
        th { background-color: #f0f0f0; font-weight: bold; }
        .diagram-box { border: 2px solid #000; padding: 15px; margin: 20px 0; font-family: 'Courier New', monospace; font-size: 9pt; background-color: #f9f9f9; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>6. DESIGN</h1>
    
    <h2>6.1 System Architecture</h2>
    
    <p class="no-indent">Three-tier architecture: Presentation (Next.js), Application (Go Fiber API), Data (PostgreSQL, Redis, DigitalOcean Spaces). Communication via RESTful APIs, SSE for streaming, S3 for storage.</p>
    
    <div class="diagram-box">
┌────────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                              │
│                   (Next.js 15 + React 19 + TypeScript)                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │
│  │    Pages     │  │  Components  │  │    Hooks     │  │   State    │ │
│  │  (Routing)   │  │   (shadcn)   │  │ (React Hook) │  │  (TanStack)│ │
│  └──────────────┘  └──────────────┘  └──────────────┘  └────────────┘ │
└────────────────────────────────┬───────────────────────────────────────┘
                                 │ HTTPS/REST API + SSE
                                 ▼
┌────────────────────────────────────────────────────────────────────────┐
│                        APPLICATION LAYER                               │
│                         (Go 1.24 + Fiber 2.52)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │
│  │   Handlers   │  │   Services   │  │  Middleware  │  │   Utils    │ │
│  │  (API Routes)│  │ (Business)   │  │  (Auth,CORS) │  │ (Crypto)   │ │
│  └──────────────┘  └──────────────┘  └──────────────┘  └────────────┘ │
└────────────────┬──────────────┬─────────────┬──────────────┬──────────┘
                 ▼              ▼             ▼              ▼
┌───────────────────┐ ┌─────────────┐ ┌──────────────┐ ┌──────────────┐
│   PostgreSQL 15   │ │  Redis 7    │ │ DO Spaces    │ │ DO GradientAI│
│  (30+ Tables)     │ │ (Cache/TTL) │ │ (S3 Storage) │ │ (Llama 3.3)  │
└───────────────────┘ └─────────────┘ └──────────────┘ └──────────────┘
    </div>
    
    <h2>6.2 Design Patterns Used</h2>
    
    <ul>
        <li><strong>Repository Pattern:</strong> GORM-based data access layer abstracts database operations</li>
        <li><strong>Service Layer Pattern:</strong> Business logic separated from handlers and data access</li>
        <li><strong>Middleware Chain:</strong> JWT auth, CORS, rate limiting, logging as composable middleware</li>
        <li><strong>Provider Pattern:</strong> React context providers for auth, theme, and query state</li>
        <li><strong>Observer Pattern:</strong> SSE for real-time streaming of AI responses and job status</li>
        <li><strong>Factory Pattern:</strong> Service initialization with dependency injection</li>
    </ul>
    
    <h2>6.3 Data Flow Summary</h2>
    
    <h3>6.3.1 Context Diagram (Level 0)</h3>
    
    <div class="diagram-box">
┌──────────┐     Login, Upload, Questions     ┌──────────────┐
│ Student  │─────────────────────────────────>│  Study in    │
│   User   │<─────────────────────────────────│   Woods      │
└──────────┘   Auth Tokens, AI Responses      └──────┬───────┘
                                                     │
┌──────────┐     Manage Users, Config                │
│  Admin   │─────────────────────────────────────────┘
└──────────┘     Audit Logs, Reports
                           │
         ┌─────────────────┼─────────────────┐
         ▼                 ▼                 ▼
  ┌─────────────┐   ┌──────────┐   ┌─────────────────┐
  │ DO AI API   │   │ Database │   │  Email Service  │
  └─────────────┘   └──────────┘   └─────────────────┘
    </div>
    
    <h3>6.3.2 System Decomposition (Level 1)</h3>
    
    <div class="diagram-box">
Student ──> [1.0 Authentication] ──> User Database
              │
              ├──> [2.0 Academic Management] ──> University/Course/Subject DB
              ├──> [3.0 Document Processing] ──> DO Spaces + AI Extraction
              ├──> [4.0 AI Chat System] ──> Knowledge Base + AI Service
              └──> [5.0 Analytics] ──> Activity Logs

Admin ──> [6.0 Administration] ──> All Databases + Audit Logs
    </div>
    
    <div class="page-break"></div>
    
    <h2>6.4 Entity Relationship Diagram</h2>
    
    <p class="no-indent">Database: 30+ tables. Core hierarchy: University → Course → Semester → Subject → Documents/ChatSessions.</p>
    
    <div class="diagram-box">
┌──────────────┐         ┌──────────────┐
│   User       │         │ University   │
│ PK id        │         │ PK id        │
│    email     │         │    name      │
│    role      │         │    code      │
└──────┬───────┘         └──────┬───────┘
       │ 1:N                    │ 1:N
       │                        ▼
       │                 ┌──────────────┐       ┌──────────────┐
       │                 │   Course     │──1:N─>│  Semester    │
       │                 │ FK univ_id   │       │ FK course_id │
       │                 └──────────────┘       └──────┬───────┘
       │                                               │ 1:N
       │                                               ▼
       │                                        ┌──────────────┐
       │                                        │   Subject    │
       │                                        │ FK semester  │
       │                                        │    kb_uuid   │
       │                                        └───┬──────────┘
       │ 1:N                                        │ 1:N
       ▼                                            ▼
┌──────────────┐                            ┌──────────────┐
│ ChatSession  │                            │  Document    │──1:N─> Syllabus
│ FK user_id   │                            │ FK subject   │         │
│ FK subject   │                            │    status    │    SyllabusUnit
└──────┬───────┘                            └──────────────┘         │
       │ 1:N                                                   SyllabusTopic
       ▼
┌──────────────┐   Other: APIKey, UserActivity, AdminAuditLog,
│ ChatMessage  │         AppSetting, PYQ, ChatMemory, IndexingJob
│ FK session   │
│    citations │
└──────────────┘
    </div>
    
    <h2>6.5 Key Sequence Flows</h2>
    
    <h3>6.5.1 Authentication Flow</h3>
    <div class="diagram-box">
User ─> Frontend ─> POST /login ─> Validate ─> DB Lookup ─> bcrypt Check
                                                    │
                    <── JWT Token ── Generate JWT <─┘
                           │
                    Store Session in Redis (24h TTL)
    </div>
    
    <h3>6.5.2 Document Upload & AI Extraction</h3>
    <div class="diagram-box">
User ─> Upload PDF ─> Validate ─> Upload to DO Spaces ─> Save Metadata (pending)
                                        │
              [Background]              ▼
         AI Extract Syllabus ─> Parse JSON ─> Store Units/Topics
                    │
         Index to Knowledge Base ─> Poll Status ─> Update (completed)
    </div>
    
    <h3>6.5.3 AI Chat with RAG</h3>
    <div class="diagram-box">
User Question ─> Get Session History ─> Query Knowledge Base ─> Get Citations
                                               │
              <── SSE Stream ── AI Response <──┘
                     │
              Save Messages + Citations to DB
    </div>
    
    <div class="page-break"></div>
    
    <h2>6.6 Component Architecture</h2>
    
    <h3>6.6.1 Backend Layers</h3>
    
    <div class="diagram-box">
┌─────────────────────────────────────────────────────────────────┐
│ API Layer: Auth | Course | Document | Chat | Admin Handlers    │
├─────────────────────────────────────────────────────────────────┤
│ Middleware: JWT Verify | CORS | Rate Limit (Redis) | Logger    │
├─────────────────────────────────────────────────────────────────┤
│ Service Layer: AuthService | SyllabusExtractor | ChatService   │
├─────────────────────────────────────────────────────────────────┤
│ Repository Layer: User | Subject | Document | Chat (GORM)      │
├─────────────────────────────────────────────────────────────────┤
│ Data: PostgreSQL (30+ tables) | Redis (Cache/Sessions)         │
├─────────────────────────────────────────────────────────────────┤
│ External: DO Spaces (S3) | DO GradientAI (LLM/KB) | SMTP       │
└─────────────────────────────────────────────────────────────────┘
    </div>
    
    <h3>6.6.2 Frontend Structure</h3>
    
    <div class="diagram-box">
App (Next.js Router)
├── Layout: Header | Sidebar | Footer
├── Pages
│   ├── Auth: /login, /register
│   ├── Dashboard: Stats, Activity, Actions
│   ├── Academic: /universities, /courses, /subjects
│   ├── Chat: /chat/[subjectId] - Sessions, Messages, Citations
│   ├── Analytics: Charts, Stats, Activity Table
│   └── Admin: Users, Settings, Audit Logs
├── Providers: QueryProvider | ThemeProvider | AuthProvider
└── Utils: API Client (Axios) | Hooks | Validators (Zod)
    </div>

</body>
</html>
