<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database - Study in Woods</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        @page { size: A4; margin: 1in; }
        body { font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 1.6; color: #000; }
        h1 { text-align: center; font-size: 16pt; font-weight: bold; text-decoration: underline; margin: 20px 0 30px 0; text-transform: uppercase; }
        h2 { font-size: 14pt; font-weight: bold; margin-top: 25px; margin-bottom: 15px; text-decoration: underline; }
        h3 { font-size: 12pt; font-weight: bold; margin-top: 20px; margin-bottom: 10px; font-style: italic; }
        p { text-align: justify; margin-bottom: 12px; text-indent: 0.5in; }
        p.no-indent { text-indent: 0; }
        .page-break { page-break-after: always; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 10pt; }
        th, td { border: 1px solid #000; padding: 6px; text-align: left; vertical-align: top; }
        th { background-color: #f0f0f0; font-weight: bold; }
        .table-name { font-weight: bold; font-size: 11pt; margin-top: 15px; margin-bottom: 5px; }
        .table-group { margin: 15px 0; padding: 10px; border-left: 3px solid #333; }
        .compact-table td { padding: 4px 6px; }
    </style>
</head>
<body>
    <h1>7. DATABASE</h1>
    
    <h2>7.1 Database Overview</h2>
    
    <p>The Study in Woods platform uses PostgreSQL 15.x as its primary relational database management system, storing all persistent application data across <strong>30+ tables</strong>. The database schema follows normalization principles (3NF) to minimize data redundancy while maintaining referential integrity through foreign key constraints. GORM (Go Object Relational Mapping) library manages database operations, automatic migrations, and relationship handling.</p>
    
    <h2>7.2 Database Schema Summary</h2>
    
    <table>
        <thead>
            <tr>
                <th>Category</th>
                <th>Tables</th>
                <th>Purpose</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>User Management</td><td>users, jwt_token_blacklist</td><td>Authentication, authorization, session management</td></tr>
            <tr><td>Academic Hierarchy</td><td>universities, courses, semesters, subjects</td><td>Educational structure and curriculum organization</td></tr>
            <tr><td>Document Management</td><td>documents, syllabuses, syllabus_units, syllabus_topics</td><td>File storage, syllabus extraction, content indexing</td></tr>
            <tr><td>Chat System</td><td>chat_sessions, chat_messages, chat_memories, chat_compacted_contexts</td><td>AI conversations, context management, memory optimization</td></tr>
            <tr><td>PYQ System</td><td>pyq_papers, pyq_questions, pyq_question_choices, pyq_crawler_sources, pyq_crawled_papers</td><td>Previous year questions management and crawling</td></tr>
            <tr><td>System & Audit</td><td>api_keys, api_key_usage_logs, user_activities, admin_audit_logs, app_settings</td><td>API management, activity tracking, configuration</td></tr>
            <tr><td>Background Jobs</td><td>indexing_jobs, indexing_job_items, cron_job_logs</td><td>Asynchronous processing, job scheduling</td></tr>
            <tr><td>User Engagement</td><td>user_notifications, user_courses</td><td>Notifications, enrollment tracking</td></tr>
        </tbody>
    </table>
    
    <h2>7.3 Core Table Definitions</h2>
    
    <h3>7.3.1 users</h3>
    <p class="no-indent">Primary table for user authentication and profile management.</p>
    <table class="compact-table">
        <thead>
            <tr><th>Column</th><th>Type</th><th>Key/Constraint</th></tr>
        </thead>
        <tbody>
            <tr><td>id</td><td>SERIAL</td><td>PRIMARY KEY</td></tr>
            <tr><td>email</td><td>VARCHAR(255)</td><td>UNIQUE, NOT NULL</td></tr>
            <tr><td>password_hash, password_salt</td><td>VARCHAR(255), BYTEA</td><td>NOT NULL (bcrypt)</td></tr>
            <tr><td>name</td><td>VARCHAR(255)</td><td>NOT NULL</td></tr>
            <tr><td>role</td><td>VARCHAR(20)</td><td>DEFAULT 'student' (student/admin)</td></tr>
            <tr><td>semester, token_version</td><td>INTEGER</td><td>DEFAULT 1, 0</td></tr>
            <tr><td>created_at, updated_at, deleted_at</td><td>TIMESTAMP</td><td>Soft delete support</td></tr>
        </tbody>
    </table>
    <p class="no-indent"><strong>Relations:</strong> Has many ChatSessions, ChatMessages, UserCourses, AdminAuditLogs</p>
    
    <h3>7.3.2 Academic Hierarchy (universities → courses → semesters → subjects)</h3>
    
    <table class="compact-table">
        <thead>
            <tr><th>Table</th><th>Key Columns</th><th>Foreign Key</th></tr>
        </thead>
        <tbody>
            <tr><td>universities</td><td>id, name, code (UNIQUE), location, is_active</td><td>—</td></tr>
            <tr><td>courses</td><td>id, name, code (UNIQUE), duration, description</td><td>university_id → universities(id)</td></tr>
            <tr><td>semesters</td><td>id, number, name</td><td>course_id → courses(id)</td></tr>
            <tr><td>subjects</td><td>id, name, code, credits, knowledge_base_uuid, agent_uuid</td><td>semester_id → semesters(id)</td></tr>
        </tbody>
    </table>
    <p class="no-indent">All tables include created_at, updated_at timestamps. CASCADE delete propagates through hierarchy.</p>
    
    <div class="page-break"></div>
    
    <h3>7.3.3 documents</h3>
    <p class="no-indent">Stores uploaded PDFs and tracks indexing status with DigitalOcean Knowledge Base.</p>
    <table class="compact-table">
        <thead>
            <tr><th>Column</th><th>Type</th><th>Purpose</th></tr>
        </thead>
        <tbody>
            <tr><td>id</td><td>SERIAL</td><td>PRIMARY KEY</td></tr>
            <tr><td>subject_id</td><td>INTEGER</td><td>FK → subjects(id)</td></tr>
            <tr><td>type</td><td>VARCHAR(20)</td><td>'syllabus', 'pyq', 'book', 'reference', 'notes'</td></tr>
            <tr><td>filename, file_size, page_count</td><td>VARCHAR, BIGINT, INT</td><td>File metadata</td></tr>
            <tr><td>spaces_url, spaces_key</td><td>TEXT, VARCHAR</td><td>DigitalOcean Spaces storage</td></tr>
            <tr><td>data_source_id, indexing_job_id</td><td>VARCHAR(100)</td><td>Knowledge Base integration</td></tr>
            <tr><td>indexing_status</td><td>VARCHAR(20)</td><td>'pending', 'in_progress', 'completed', 'failed'</td></tr>
        </tbody>
    </table>
    
    <h3>7.3.4 Syllabus Structure (syllabuses → syllabus_units → syllabus_topics)</h3>
    <table class="compact-table">
        <thead>
            <tr><th>Table</th><th>Key Columns</th><th>Foreign Key</th></tr>
        </thead>
        <tbody>
            <tr><td>syllabuses</td><td>id, subject_name, subject_code, total_credits, extraction_status, raw_extraction</td><td>subject_id, document_id</td></tr>
            <tr><td>syllabus_units</td><td>id, unit_number, title, description, hours</td><td>syllabus_id → syllabuses(id)</td></tr>
            <tr><td>syllabus_topics</td><td>id, topic_number, title, description, keywords</td><td>unit_id → syllabus_units(id)</td></tr>
        </tbody>
    </table>
    
    <h3>7.3.5 Chat System</h3>
    
    <p class="table-name">chat_sessions</p>
    <table class="compact-table">
        <thead><tr><th>Column</th><th>Type</th><th>Key/Constraint</th></tr></thead>
        <tbody>
            <tr><td>id</td><td>SERIAL</td><td>PRIMARY KEY</td></tr>
            <tr><td>user_id</td><td>INTEGER</td><td>FK → users(id)</td></tr>
            <tr><td>subject_id</td><td>INTEGER</td><td>FK → subjects(id)</td></tr>
            <tr><td>title</td><td>VARCHAR(255)</td><td>Auto-generated or user-set</td></tr>
        </tbody>
    </table>
    
    <p class="table-name">chat_messages</p>
    <table class="compact-table">
        <thead><tr><th>Column</th><th>Type</th><th>Purpose</th></tr></thead>
        <tbody>
            <tr><td>id, session_id, subject_id, user_id</td><td>INTEGER</td><td>PK and Foreign Keys</td></tr>
            <tr><td>role</td><td>VARCHAR(20)</td><td>'user', 'assistant', 'system'</td></tr>
            <tr><td>content</td><td>TEXT</td><td>Message content</td></tr>
            <tr><td>citations</td><td>JSONB</td><td>Knowledge Base citations array</td></tr>
            <tr><td>tokens_used, model_used, response_time</td><td>INT, VARCHAR, INT</td><td>Usage analytics</td></tr>
            <tr><td>is_streamed</td><td>BOOLEAN</td><td>SSE streaming flag</td></tr>
        </tbody>
    </table>
    
    <p class="no-indent"><strong>Additional Chat Tables:</strong> chat_memories (conversation context), chat_memory_batches (batch processing), chat_compacted_contexts (compressed long-term memory)</p>
    
    <h3>7.3.6 System & Audit Tables</h3>
    <table class="compact-table">
        <thead><tr><th>Table</th><th>Key Columns</th><th>Purpose</th></tr></thead>
        <tbody>
            <tr><td>api_keys</td><td>id, user_id, key_hash, name, is_active</td><td>Encrypted API key storage</td></tr>
            <tr><td>api_key_usage_logs</td><td>id, user_id, service, endpoint, status_code</td><td>API consumption tracking</td></tr>
            <tr><td>user_activities</td><td>id, user_id, action, resource_type, resource_id, ip_address</td><td>User action tracking</td></tr>
            <tr><td>admin_audit_logs</td><td>id, admin_id, action, target_type, target_id, changes (JSONB)</td><td>Admin action audit trail</td></tr>
            <tr><td>app_settings</td><td>id, key (UNIQUE), value, description</td><td>Application configuration</td></tr>
            <tr><td>jwt_token_blacklist</td><td>id, user_id, token_hash (UNIQUE), expires_at</td><td>Invalidated token tracking</td></tr>
        </tbody>
    </table>
    
    <h2>7.4 Entity Relationships</h2>
    
    <p>The database follows a hierarchical structure with cascading relationships:</p>
    
    <p class="no-indent"><strong>Primary Relationships:</strong></p>
    <ul style="margin-left: 0.5in; margin-bottom: 15px;">
        <li>universities (1) → (M) courses → (M) semesters → (M) subjects</li>
        <li>subjects (1) → (M) documents, syllabuses, chat_sessions</li>
        <li>users (1) → (M) chat_sessions → (M) chat_messages</li>
        <li>syllabuses (1) → (M) syllabus_units → (M) syllabus_topics</li>
        <li>users (1) → (M) api_keys, user_activities, admin_audit_logs</li>
    </ul>
    
    <p class="no-indent"><strong>ER Diagram Reference:</strong> The complete Entity-Relationship diagram is available in the Design section (Chapter 6), showing all 30+ tables with their relationships, cardinality, and key constraints.</p>
    
    <h2>7.5 Indexes and Performance</h2>
    
    <p>Strategic indexing optimizes query performance:</p>
    <ul style="margin-left: 0.5in; margin-bottom: 15px;">
        <li><strong>B-tree indexes:</strong> All foreign keys (user_id, subject_id, session_id, course_id, semester_id)</li>
        <li><strong>Unique indexes:</strong> Email addresses, codes, token hashes</li>
        <li><strong>Composite indexes:</strong> (user_id, created_at) for user activity queries</li>
        <li><strong>Partial indexes:</strong> indexing_status='pending' for background job processing</li>
        <li><strong>GIN indexes:</strong> JSONB columns (citations, metadata) for @> containment queries</li>
    </ul>
    
    <p><strong>Connection Management:</strong> pgx driver maintains 25-100 concurrent connections with 1-hour max lifetime. Query optimization includes prepared statement caching, GORM preloading to prevent N+1 queries, and Redis caching with 5-minute TTL.</p>
</body>
</html>
